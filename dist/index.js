"use strict";var __importDefault=function(e){return e&&e.__esModule?e:{default:e}},tinify_1=__importDefault(require("tinify")),through2_1=__importDefault(require("through2")),path_1=__importDefault(require("path")),fancy_log_1=__importDefault(require("fancy-log")),fs_1=__importDefault(require("fs")),md5_1=__importDefault(require("md5")),pretty_bytes_1=__importDefault(require("pretty-bytes")),request_1=__importDefault(require("request")),imagemin_1=__importDefault(require("imagemin")),imagemin_optipng_1=__importDefault(require("imagemin-optipng")),imagemin_jpegtran_1=__importDefault(require("imagemin-jpegtran")),imagemin_gifsicle_1=__importDefault(require("imagemin-gifsicle")),CACHE_DIR="./.gulp-tiny-cache/",TINY_WEB_API="https://tinypng.com/web/shrink",hasLog=!1,isTinyKeyValid=void 0,verifyKey=function(e){return new Promise(function(t,n){return"imagemin"===e?n("imagemin"):isTinyKeyValid?t(!0):!1===isTinyKeyValid?t(!1):(tinify_1.default.key=e,void tinify_1.default.validate(function(e){if(e)return isTinyKeyValid=!1,e.toString().includes("401")?(fancy_log_1.default("熊猫key无效，开始使用web api"),fancy_log_1.default("----------------------------"),t(!1)):n(e);fancy_log_1.default("熊猫key有效，开始使用"),fancy_log_1.default("---------------------"),t(isTinyKeyValid=!0)}))})},hasCheckTempDir=!1,createTempDir=function(){return new Promise(function(t,n){if(hasCheckTempDir)return t();fs_1.default.access(CACHE_DIR,fs_1.default.constants.F_OK,function(e){e?fs_1.default.mkdir(CACHE_DIR,{recursive:!0},function(e){if(e)return n();hasCheckTempDir=!0,t()}):(hasCheckTempDir=!0,t())})})},readTempFile=function(i){return new Promise(function(n,a){var e=path_1.default.extname(i.path),t=path_1.default.basename(i.path,e)+e;fs_1.default.readFile(CACHE_DIR+md5_1.default(t),function(e,t){if(e)return a();n(t)})})},compressByTinyKey=function(e){return new Promise(function(n,a){readTempFile(e).then(function(e){return n({cache:!0,resultData:e})}).catch(function(){return tinify_1.default.fromBuffer(e.contents).toBuffer(function(e,t){if(e)return a(e);n({way:"tinykey",cache:!1,resultData:t})})})})},compressByWebApi=function(t){return new Promise(function(a,i){var e=path_1.default.extname(t.path),r=path_1.default.basename(t.path,e)+e;readTempFile(t).then(function(e){return a({cache:!0,resultData:e})}).catch(function(){return request_1.default({url:TINY_WEB_API,method:"post",headers:{accept:"*/*","accept-encoding":"gzip, deflate, br","accept-language":"zh-CN,zh;q=0.9,en;q=0.8","cache-control":"no-cache",origin:"https://tinypng.com",pragma:"no-cache",referer:"https://tinypng.com/","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"},body:t.contents},function(e,t,n){if(e)return i("webapi 网络错误");try{request_1.default(JSON.parse(n).output.url).pipe(fs_1.default.createWriteStream(CACHE_DIR+md5_1.default(r))).on("close",function(){fs_1.default.readFile(CACHE_DIR+md5_1.default(r),function(e,t){if(e)return i(e);a({way:"webapi",cache:!1,resultData:t})})})}catch(e){hasLog=!1,i("webapi 响应数据有误")}})})})},compressByImagemin=function(e){return new Promise(function(t){readTempFile(e).then(function(e){return t({cache:!0,resultData:e})}).catch(function(){return imagemin_1.default.buffer(e.contents,{plugins:[imagemin_optipng_1.default(),imagemin_jpegtran_1.default(),imagemin_gifsicle_1.default()]}).then(function(e){return t({way:"imagemin",cache:!1,resultData:e})})})})};module.exports=function(e){var l=e.key||"imagemin",t=e.tinyTag,_=void 0===t?"":t,n=e.minSize,s=void 0===n?4096:n,a=e.verbose,m=void 0!==a&&a,i=e.jsonDest,r=void 0===i?CACHE_DIR:i,d=0,p=0,y=0,g=[".jpg",".png",".gif"],h=[];return through2_1.default.obj(function(n,e,a){if(n.isNull())return a(null);if(n.isStream())return a("不支持stream");var t=path_1.default.extname(n.path),i=path_1.default.basename(n.path,t)+t,r=path_1.default.basename(n.path,t)+_+t,u=n.stat.size,f=null,c=void 0,o="";return g.includes(t)?u<=s?a(null,n):void createTempDir().then(function(){verifyKey(l).then(function(e){return".gif"===t?compressByImagemin(n):e?compressByTinyKey(n):compressByWebApi(n)}).catch(function(e){return hasLog||(e.toString().includes("connecting")?fancy_log_1.default.error("莫得网络，开始使用imagemin"):"imagemin"===e?(fancy_log_1.default("开始使用imagemin"),fancy_log_1.default("-----------------")):(fancy_log_1.default.error(e.toString()+"，开始使用imagemin"),fancy_log_1.default("--------------------------------------------")),hasLog=!0),l="imagemin",compressByImagemin(n)}).then(function(e){f=e.resultData,c=e.cache,o=e.way||"cache"}).finally(function(){n.contents=f,n.path=path_1.default.join(n.base,r);var e=f.length,t=u-e;y+=t,c?m&&fancy_log_1.default("* from cache:",pretty_bytes_1.default(u)+" -> "+pretty_bytes_1.default(e),"(saved ".concat(pretty_bytes_1.default(t)," ").concat((t/u*100).toFixed(2),"%)"),r):t?(d++,fancy_log_1.default("".concat(d,".from ").concat(o,":"),pretty_bytes_1.default(u)+" -> "+pretty_bytes_1.default(e),"(saved ".concat(pretty_bytes_1.default(t)," ").concat((t/u*100).toFixed(2),"%)"),r)):m&&fancy_log_1.default("minified saved:",r),h.push(r),"webapi"!==o&&fs_1.default.createWriteStream(CACHE_DIR+md5_1.default(i)).write(n.contents),p+=t/u*100,a(null,n)})}).catch(function(e){return a(e)}):a()},function(e){d?fancy_log_1.default("已压缩图片：".concat(d," 总节省空间大小").concat(pretty_bytes_1.default(y)," 总节省空间百分比：").concat((p/d).toFixed(2),"%")):fancy_log_1.default("没有需要被压缩的图片"),fs_1.default.mkdir(r,{recursive:!0},function(e){return!e&&fs_1.default.createWriteStream(path_1.default.join(r,"imgs.json")).write(JSON.stringify(h))}),isTinyKeyValid&&fancy_log_1.default("本月熊猫key已压缩图片："+tinify_1.default.compressionCount),e()})};